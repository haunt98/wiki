# 02_go

[Custom marshalers in Go: An unexpected gotcha](https://www.snprajwal.com/tech/custom-marshalers-in-go/).

That‚Äôs why I can‚Äôt marshal zap recursively.

[Go‚Äôs best-kept secret: executable examples](https://bitfieldconsulting.com/golang/examples)

```go
func ExampleDouble() {
    fmt.Println(double.Double(2))
    // Output:
    // 4
}
```

[errors.Join ‚ù§Ô∏è defer](https://wstrm.dev/posts/errors-join-heart-defer/)

```go
func example(r io.ReadCloser) (err error) {
	defer func() {
		err = errors.Join(err, r.Close()) // Magic!
	}()

	// ... code that reads from r ...
}

func joinErrs(origErr *error, fn func() error) {
	*origErr = errors.Join(*origErr, fn())
}

func example(r io.ReadCloser) (err error) {
	defer joinErrs(&err, r.Close) // Woho! Only a single line :D

	// ... code that reads from r ...
}
```

Go pipe, tee example:

```go
// Use both pipe and tee reader
func strategy1() string {
	file, err := os.Open(filename)
	if err != nil {
		panic(err)
	}
	defer file.Close()

	pipeReader, pipeWriter := io.Pipe()
	fileReader := io.TeeReader(file, pipeWriter)

	var eg errgroup.Group
	var result1 string
	var result2 string
	eg.Go(func() error {
		defer pipeWriter.Close()

		fileBytes, err := io.ReadAll(fileReader)
		if err != nil {
			return err
		}

		result1 = base64.StdEncoding.EncodeToString(fileBytes)

		return nil
	})

	eg.Go(func() error {
		pipeBytes, err := io.ReadAll(pipeReader)
		if err != nil {
			return err
		}

		result2 = base64.StdEncoding.EncodeToString(pipeBytes)

		return nil
	})

	eg.Wait()

	if result1 != result2 {
		panic("result1 != result2")
	}

	return result1
}

// Use pipe with bytes buffer
func strategy2() string {
	file, err := os.Open(filename)
	if err != nil {
		panic(err)
	}
	defer file.Close()

	var buf bytes.Buffer
	fileReader := io.TeeReader(file, &buf)

	// Need to read from fileReader first
	fileBytes, err := io.ReadAll(fileReader)
	if err != nil {
		panic(err)
	}

	result1 := base64.StdEncoding.EncodeToString(fileBytes)

	// After that, read from buf
	result2 := base64.StdEncoding.EncodeToString(buf.Bytes())

	if result1 != result2 {
		panic("result1 != result2")
	}

	return result1
}
```

[https://zostay.com/posts/2022/05/04/do-not-use-libsodium-with-go/]()

```go
import (
    "crypto/rand"
    "encoding/base64"
    "golang.org/x/crypto/nacl/box"
)

func encryptSecret(pk, secret string) (string, error) {
    var pkBytes [32]byte
    copy(pkBytes[:], pk)
    secretBytes := secret

    out := make([]byte, 0,
        len(secretBytes)+
        box.Overhead+
        len(pkBytes))

    enc, err := box.SealAnonymous(
        out, secretBytes, &pkBytes, rand.Reader,
    )
    if err != nil {
        return "", err
    }

    encEnc := base64.StdEncoding.EncodeToString(enc)

    return encEnc, nil
}
```

[Go Context timeouts can be harmful](https://uptrace.dev/blog/golang-context-timeout.html)

```go
rdb := redis.NewClient(&redis.Options{
    ReadTimeout:  3 * time.Second,
    WriteTimeout: 3 * time.Second,
})
```

[Go Concurrency: Fan-out, Fan-in](https://pboyd.io/posts/go-concurrency-fan-out-fan-in/)

```go
func (idx *Index) findImages(ctx context.Context, path string) <-chan string {
	ch := make(chan string)
	go func() {
		defer close(ch)

		err := filepath.WalkDir(path, func(path string, d fs.DirEntry, err error) error {
			if err != nil {
				log.Printf("%s: %s", path, err)
				return nil
			}

			ext := strings.ToLower(filepath.Ext(path))
			switch ext {
			case ".jpg", ".jpeg", ".png", ".gif":
			default:
				return nil
			}

			select {
			case ch <- path:
			case <-ctx.Done():
				return fs.SkipAll
			}

			return nil
		})
		if err != nil {
			log.Fatalf("error walking path %s: %s", path, err)
		}
	}()
	return ch
}
```

[Advanced Go Concurrency](https://encore.dev/blog/advanced-go-concurrency)

```go
func Cities(cities ...string) ([]*Info, error) {
    ctx := context.TODO() // replace with a real context
    var g errgroup.Group
    var mu sync.Mutex
    res := make([]*Info, len(cities)) // res[i] corresponds to cities[i]
    sem := semaphore.NewWeighted(100) // 100 chars processed concurrently
    for i, city := range cities {
        i, city := i, city // create locals for closure below
        cost := int64(len(city))
        if err := sem.Acquire(ctx, cost); err != nil {
            break
        }
        g.Go(func() error {
            info, err := City(city)
            mu.Lock()
            res[i] = info
            mu.Unlock()
            sem.Release(cost)
            return err
        })
    }
    if err := g.Wait(); err != nil {
        return nil, err
    } else if err := ctx.Err(); err != nil {
        return nil, err
    }
    return res, nil
}
```

[Coming Soon: Golang 1.22 üöÄ](https://www.dolthub.com/blog/2024-01-12-golang-1-22rc/)

Search Loop Variable Reallocation aka `i := i`:

```sh
egrep -R '\t(\w+) := \1$' .

rg '\s+(\w+) := \1$'
```

[Why precision matters in payments ledgering](https://moov.io/blog/product/high-precision-ledger/)

```go
type Money {
    Value       decimal.Decimal
    Currency    iso4217.CurrencyCode
}
```

> So now, rather than storing a value as an integer, we can store it in the
> conventional decimal format.
>
> The decimal library gives us some useful tools right out of the box, like
> performing basic arithmetic on values with different decimal points, for
> example, 0.001 + 0.0001. This may seem trivial, but implementing the logic for
> it isn‚Äôt. This library allows us to safely handle the math behind the scenes,
> which is crucial for maintaining accuracy and correctness.

- [Go's time.Time and time.Location explained](https://www.willem.dev/articles/time-location-explained/)
- [time.Now() and the Monotonic Clock](https://www.willem.dev/articles/time-now-monotonic-clock/)
- [Remove Monotonic Clock Reading from time.Time](https://www.willem.dev/code-snippets/remove-monotonic-time/)
- [How and why the leap second affected Cloudflare DNS](https://blog.cloudflare.com/how-and-why-the-leap-second-affected-cloudflare-dns)

> - Wall clocks are for ‚Äútelling time‚Äù: assigning a useful meaning to a clock
  > reading.
> - Monotonic clocks are for ‚Äúmeasuring time‚Äù: showing the passage of time
  > between clock readings.
>
> The system clock is a wall clock, it‚Äôs coordinated with the rest of the world
> and can be used to tell time.
>
> The monotonic clock is a monotonic clock that is reset when the system
> restarts, it‚Äôs only guarantee is that it ticks forward (at a consistent pace).
> Clock readings are not coordinated, but can be used for measuring time while a
> program is running.
>
> In Go the time.Time is used for both telling time and measuring time.
>
> To achieve this, the time.Time type can store two elements: a wall time
> element and a monotonic element.

## References

- [Common Concurrent Programming Mistakes](https://go101.org/article/concurrent-common-mistakes.html)
- [Go Slice Tricks Cheat Sheet](https://ueokande.github.io/go-slice-tricks/)
- [Synchronization Constructs in the Go Standard Library](https://hjr265.me/blog/synchronization-constructs-in-go-standard-library/)
- [How to start a Go project in 2023](https://boyter.org/posts/how-to-start-go-project-2023/)
- [Go Programming Blueprints by Mat Ryer](https://mtlynch.io/book-reports/go-programming-blueprints/)
- [GopherCon 2023: Future-Proof Go Packages](https://abhinavg.net/2023/09/27/future-proof-packages/)
- [The Busy Developer's Guide to Go Profiling, Tracing and Observability](https://github.com/DataDog/go-profiler-notes/blob/main/guide/README.md)
- [Flame Graphs for Go With pprof](https://www.benburwell.com/posts/flame-graphs-for-go-with-pprof/)
- [go test and parallelism](https://bryce.is/writing/code/go-test-and-parallelism.html)
- [Common pitfalls in Go benchmarking](https://eli.thegreenplace.net/2023/common-pitfalls-in-go-benchmarking/)
- [Go memory metrics demystified](https://www.datadoghq.com/blog/go-memory-metrics/)
- [From slow to SIMD: A Go optimization story](https://sourcegraph.com/blog/slow-to-simd)
- [Rob Pike‚Äôs simple C regex matcher in Go](https://benhoyt.com/writings/rob-pike-regex/)
- [Fearless CORS: a design philosophy for CORS middleware libraries (and a Go implementation)](https://jub0bs.com/posts/2023-02-08-fearless-cors/)
- [Introduction to CORS for Go programmers](https://eli.thegreenplace.net/2023/introduction-to-cors-for-go-programmers/)
- [gRPC load balancing with grpc-go](https://rafaeleyng.github.io/grpc-load-balancing-with-grpc-go)
- [Time is not a synchronization primitive](https://xeiaso.net/blog/nosleep/)
- [filepath.Clean: terms and conditions apply](https://tortel.li/post/dirty_filepath/)
- [Understanding a recent optimization to Go's reflect.TypeFor](https://utcc.utoronto.ca/~cks/space/blog/programming/GoReflectTypeForOptimization)
- [How do you represent a JSON field in Go that could be absent, null or have a value?](https://www.jvt.me/posts/2024/01/09/go-json-nullable/)
- [What‚Äôs New in Go 1.22: slices.Concat](https://trello.com/b/mvGUYg4O/mercedes-m%C3%A0u-xanh)
- [Retry function in Go](https://rednafi.com/go/retry_function/)

## Pkg

- https://github.com/allegro/bigcache
- https://github.com/brianvoe/gofakeit
- https://github.com/bsm/redislock
- https://github.com/cep21/circuit
- https://github.com/cockroachdb/swiss
- https://github.com/dgraph-io/badger
- https://github.com/dgraph-io/ristretto
- https://github.com/dsoprea/go-exif
- https://github.com/etcd-io/bbolt
- https://github.com/failsafe-go/failsafe-go
- https://github.com/fxamacker/cbor
- https://github.com/hibiken/asynq
- https://github.com/iancoleman/orderedmap
- https://github.com/jonboulle/clockwork
- https://github.com/klauspost/compress
- https://github.com/klauspost/pgzip
- https://github.com/nikolaydubina/go-recipes
- https://github.com/nyaruka/phonenumbers
- https://github.com/panjf2000/ants
- https://github.com/throttled/throttled
- https://github.com/uber-go/automaxprocs
